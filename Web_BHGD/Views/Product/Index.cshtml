@model IEnumerable<Web_BHGD.Models.Product>
@{
    ViewData["Title"] = "Danh sách sản phẩm";
}

<div class="container my-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Trang chủ</a></li>
                    <li class="breadcrumb-item active">Sản phẩm</li>
                </ol>
            </nav>
            <h1 class="h2 mb-0">
                <i class="bi bi-grid-3x3-gap text-primary me-2"></i>
                Danh sách sản phẩm
            </h1>
            <p class="text-muted">Khám phá các sản phẩm gia dụng chất lượng cao</p>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form method="get" asp-action="Index">
                        <div class="row g-3 align-items-end">
                            <!-- Search -->
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Tìm kiếm</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" name="searchString" class="form-control"
                                           placeholder="Nhập tên sản phẩm..."
                                           value="@ViewBag.CurrentFilter">
                                </div>
                            </div>

                            <!-- Category Filter -->
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Danh mục</label>
                                @Html.DropDownList("categoryId", ViewBag.Categories as SelectList, "Tất cả danh mục",
                                         new { @class = "form-select" })
                            </div>

                            <!-- Sort -->
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Sắp xếp</label>
                                <select name="sortOrder" class="form-select">
                                    <option value="">Tên A-Z</option>
                                    <option value="name_desc" selected="@(ViewBag.CurrentSort == "name_desc")">Tên Z-A</option>
                                    <option value="price" selected="@(ViewBag.CurrentSort == "price")">Giá thấp đến cao</option>
                                    <option value="price_desc" selected="@(ViewBag.CurrentSort == "price_desc")">Giá cao đến thấp</option>
                                </select>
                            </div>

                            <!-- Submit Button -->
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-funnel me-1"></i>Lọc
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Grid -->
    <div class="row">
        @if (Model != null && Model.Any())
        {
            @foreach (var product in Model)
            {
                <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                    <div class="product-card">
                        <div class="card h-100 border-0 shadow-sm">
                            <!-- Product Image -->
                            <div class="position-relative overflow-hidden">
                                <img src="@(string.IsNullOrEmpty(product.ImageUrl) ? "/images/no-image.jpg" : product.ImageUrl)"
                                     class="card-img-top product-image" alt="@product.Name"
                                     style="height: 250px; object-fit: cover; transition: transform 0.3s;">

                                <!-- Quick View Overlay -->
                                <div class="product-overlay position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center">
                                    <a asp-action="Details" asp-route-id="@product.Id"
                                       class="btn btn-light btn-sm rounded-pill shadow">
                                        <i class="bi bi-eye me-1"></i> Xem chi tiết
                                    </a>
                                </div>

                                <!-- Price Badge -->
                                @if (product.Price < 500000)
                                {
                                    <div class="position-absolute top-0 start-0 m-2">
                                        <span class="badge bg-success">Giá tốt</span>
                                    </div>
                                }
                            </div>

                            <div class="card-body d-flex flex-column">
                                <!-- Product Name -->
                                <h5 class="card-title text-truncate mb-2" title="@product.Name">@product.Name</h5>

                                <!-- Category -->
                                <p class="text-muted small mb-2">
                                    <i class="bi bi-tag me-1"></i>@(product.Category?.Name ?? "Chưa phân loại")
                                </p>

                                <!-- Description -->
                                <p class="card-text text-muted small mb-3" style="height: 40px; overflow: hidden;">
                                    @(product.Description?.Length > 80 ? product.Description.Substring(0, 80) + "..." : product.Description)
                                </p>

                                <!-- Price -->
                                <div class="price-section mb-3 mt-auto">
                                    <span class="h5 text-primary fw-bold">@product.Price.ToString("N0")₫</span>
                                    @if (product.Price > 200000)
                                    {
                                        <small class="text-muted text-decoration-line-through ms-2">
                                            @((product.Price * 1.2m).ToString("N0"))₫
                                        </small>
                                    }
                                </div>

                                <!-- Rating -->
                                <div class="rating mb-3">
                                    @for (int i = 0; i < 5; i++)
                                    {
                                        <i class="bi bi-star-fill text-warning"></i>
                                    }
                                    <small class="text-muted ms-1">(4.8)</small>
                                </div>

                                <!-- Action Buttons -->
                                <div class="d-grid gap-2">
                                    @if (User.Identity.IsAuthenticated)
                                    {
                                        <button type="button" class="btn btn-primary add-to-cart-btn"
                                                data-product-id="@product.Id"
                                                data-product-name="@product.Name">
                                            <i class="bi bi-cart-plus me-1"></i> Thêm vào giỏ
                                        </button>
                                    }
                                    else
                                    {
                                        <a asp-area="Identity" asp-page="/Account/Login" class="btn btn-outline-primary">
                                            <i class="bi bi-box-arrow-in-right me-1"></i> Đăng nhập để mua
                                        </a>
                                    }

                                    <a asp-action="Details" asp-route-id="@product.Id" class="btn btn-outline-secondary btn-sm">
                                        <i class="bi bi-info-circle me-1"></i> Chi tiết
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="bi bi-search display-1 text-muted"></i>
                    <h3 class="mt-3">Không tìm thấy sản phẩm nào</h3>
                    <p class="text-muted">Hãy thử thay đổi từ khóa tìm kiếm hoặc bộ lọc</p>
                    <a asp-controller="Home" asp-action="Index" class="btn btn-primary">
                        <i class="bi bi-arrow-left me-1"></i> Về trang chủ
                    </a>
                </div>
            </div>
        }
    </div>
</div>

<style>
    .product-card {
        transition: transform 0.2s ease-in-out;
    }

        .product-card:hover {
            transform: translateY(-5px);
        }

    .product-overlay {
        background: rgba(0,0,0,0.7);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .product-card:hover .product-overlay {
        opacity: 1;
    }

    .product-card:hover .product-image {
        transform: scale(1.05);
    }

    .card {
        transition: box-shadow 0.3s ease;
    }

        .card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
        }
</style>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Add to cart functionality
            $('.add-to-cart-btn').click(function () {
                var btn = $(this);
                var productId = btn.data('product-id');
                var productName = btn.data('product-name');

                // Disable button and show loading
                btn.prop('disabled', true);
                btn.html('<i class="bi bi-arrow-repeat spinner-border spinner-border-sm me-1"></i> Đang thêm...');

                $.ajax({
                    url: '@Url.Action("AddToCart", "ShoppingCart")',
                    type: 'POST',
                    data: {
                        productId: productId,
                        quantity: 1
                    },
                    success: function (response) {
                        if (response.success) {
                            // Show success message
                            showToast('success', response.message);

                            // Update cart count in navbar
                            updateCartCount();

                            // Reset button
                            btn.prop('disabled', false);
                            btn.html('<i class="bi bi-cart-plus me-1"></i> Thêm vào giỏ');
                        } else {
                            showToast('error', 'Có lỗi xảy ra khi thêm sản phẩm vào giỏ hàng!');
                            btn.prop('disabled', false);
                            btn.html('<i class="bi bi-cart-plus me-1"></i> Thêm vào giỏ');
                        }
                    },
                    error: function () {
                        showToast('error', 'Có lỗi xảy ra! Vui lòng thử lại.');
                        btn.prop('disabled', false);
                        btn.html('<i class="bi bi-cart-plus me-1"></i> Thêm vào giỏ');
                    }
                });
            });
        });

        function showToast(type, message) {
            // Simple toast notification
            var toastClass = type === 'success' ? 'alert-success' : 'alert-danger';
            var toast = `<div class="alert ${toastClass} alert-dismissible fade show position-fixed"
                                    style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
                                    ${message}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                 </div>`;

            $('body').append(toast);

            // Auto dismiss after 3 seconds
            setTimeout(function () {
                $('.alert').alert('close');
            }, 3000);
        }

        function updateCartCount() {
            $.get('@Url.Action("GetCartCount", "ShoppingCart")', function (data) {
                $('.cart-count').text(data.count);
            });
        }
    </script>
}